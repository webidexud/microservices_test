<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - User Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colores corporativos */
            --primary-dark: #003366;
            --primary-medium: #005B99;
            --primary-light: #4DA6FF;
            --white: #FFFFFF;
            --surface-light: #F5F7FA;
            --border-gray: #CCCCCC;
            --text-dark: #333333;
            --success: #28A745;
            --warning: #FFC107;
            --error: #DC3545;
            
            /* Variables de aplicaci√≥n */
            --background: var(--white);
            --surface: var(--surface-light);
            --text-primary: var(--text-dark);
            --text-secondary: #666666;
            --text-light: #999999;
            --border: var(--border-gray);
            --accent: var(--primary-medium);
            --shadow: 0 2px 4px 0 rgba(0, 51, 102, 0.08);
            --shadow-lg: 0 8px 16px 0 rgba(0, 51, 102, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--surface);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Layout principal */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: var(--primary-dark);
            color: var(--white);
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--white);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Sidebar */
        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border-left-color: var(--primary-light);
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
        }

        /* Header */
        .header-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-medium);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
        }

        .logout-btn {
            background: none;
            border: 2px solid var(--primary-medium);
            color: var(--primary-medium);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: var(--primary-medium);
            color: var(--white);
        }

        /* Cards de estad√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-medium);
        }

        .stat-card.success { border-left-color: var(--success); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-card.error { border-left-color: var(--error); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        /* Secci√≥n principal */
        .section {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .btn {
            background: var(--primary-medium);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--error);
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Tabla */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--surface);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .table tr:hover {
            background: var(--surface);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.admin {
            background: var(--primary-dark);
            color: var(--white);
        }

        .badge.user {
            background: var(--success);
            color: var(--white);
        }

        .badge.moderator {
            background: var(--warning);
            color: var(--white);
        }

        .badge.active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        .badge.inactive {
            background: rgba(220, 53, 69, 0.1);
            color: var(--error);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-medium);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            background: var(--white);
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .alert.error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--error);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            
            .sidebar-header {
                padding: 20px 10px;
            }
            
            .logo {
                font-size: 16px;
                justify-content: center;
            }
            
            .nav-item {
                padding: 15px 10px;
                text-align: center;
            }
            
            .nav-item span {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    üè¢ <span>AdminPanel</span>
                </div>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-section="dashboard">
                    üìä <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-section="users">
                    üë• <span>Usuarios</span>
                </a>
                <a href="#" class="nav-item" data-section="profile">
                    üë§ <span>Mi Perfil</span>
                </a>
                <a href="#" class="nav-item" data-section="settings">
                    ‚öôÔ∏è <span>Configuraci√≥n</span>
                </a>
            </nav>
        </div>

        <!-- Contenido principal -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">Admin User</span>
                    <button class="logout-btn" onclick="logout()">Salir</button>
                </div>
            </header>

            <!-- Contenido -->
            <main class="content">
                <!-- Dashboard Section -->
                <!-- Reemplazar la secci√≥n dashboardSection completa con este c√≥digo mejorado -->

            <!-- Dashboard Section Mejorado -->
            <div id="dashboardSection" class="content-section">
                <!-- Welcome Banner -->
                <div style="background: linear-gradient(135deg, var(--primary-medium) 0%, var(--primary-dark) 100%); border-radius: 16px; padding: 30px; margin-bottom: 30px; color: white; position: relative; overflow: hidden;">
                    <div style="position: relative; z-index: 2;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">¬°Bienvenido de vuelta!</h2>
                                <p style="font-size: 16px; opacity: 0.9; margin-bottom: 20px;" id="welcomeMessage">Cargando...</p>
                                <div style="display: flex; gap: 20px; font-size: 14px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 20px;">üìÖ</span>
                                        <span id="currentDate">-</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 20px;">üïê</span>
                                        <span id="currentTime">-</span>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin-bottom: 10px;" id="bannerAvatar">A</div>
                                <div style="font-size: 14px; opacity: 0.9;" id="bannerRole">ADMIN</div>
                            </div>
                        </div>
                    </div>
                    <!-- Decorative background -->
                    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; z-index: 1;"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%; z-index: 1;"></div>
                </div>

                <!-- Estad√≠sticas principales mejoradas -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; font-size: 24px;">üë•</div>
                            <div style="text-align: right;">
                                <div class="stat-value" style="color: white; font-size: 36px;" id="totalUsers">-</div>
                                <div style="font-size: 12px; opacity: 0.8;">TOTAL</div>
                            </div>
                        </div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Usuarios</div>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;" id="totalUsersChange">+0% vs mes anterior</div>
                    </div>

                    <div class="stat-card success" style="background: linear-gradient(135deg, var(--success) 0%, #20c997 100%); color: white; border: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; font-size: 24px;">‚úÖ</div>
                            <div style="text-align: right;">
                                <div class="stat-value" style="color: white; font-size: 36px;" id="activeUsers">-</div>
                                <div style="font-size: 12px; opacity: 0.8;">ACTIVOS</div>
                            </div>
                        </div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Usuarios Activos</div>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;" id="activeUsersPercentage">0% del total</div>
                    </div>

                    <div class="stat-card warning" style="background: linear-gradient(135deg, var(--warning) 0%, #fd7e14 100%); color: white; border: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; font-size: 24px;">üÜï</div>
                            <div style="text-align: right;">
                                <div class="stat-value" style="color: white; font-size: 36px;" id="recentUsers">-</div>
                                <div style="font-size: 12px; opacity: 0.8;">NUEVOS</div>
                            </div>
                        </div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Nuevos (30 d√≠as)</div>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Este mes</div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, var(--primary-medium) 0%, var(--primary-light) 100%); color: white; border: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; font-size: 24px;">üìä</div>
                            <div style="text-align: right;">
                                <div class="stat-value" style="color: white; font-size: 36px;" id="activeLogins">-</div>
                                <div style="font-size: 12px; opacity: 0.8;">LOGINS</div>
                            </div>
                        </div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Activos (7 d√≠as)</div>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Esta semana</div>
                    </div>
                </div>

                <!-- Grid de contenido -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Distribuci√≥n por roles mejorada -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">üìä Distribuci√≥n por Roles</h2>
                            <button class="btn btn-secondary" onclick="refreshRoleStats()" style="padding: 8px 16px; font-size: 14px;">
                                üîÑ Actualizar
                            </button>
                        </div>
                        <div style="padding: 30px;">
                            <div id="roleStatsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Acciones r√°pidas -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">‚ö° Acciones R√°pidas</h2>
                        </div>
                        <div style="padding: 25px;">
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <button class="btn" onclick="openCreateUserModal()" style="justify-content: flex-start; padding: 15px;">
                                    <span style="margin-right: 10px;">üë§</span>
                                    <div>
                                        <div style="font-weight: 600;">Crear Usuario</div>
                                        <div style="font-size: 12px; opacity: 0.8;">Agregar nuevo usuario al sistema</div>
                                    </div>
                                </button>
                                <button class="btn btn-secondary" onclick="showSection('users')" style="justify-content: flex-start; padding: 15px;">
                                    <span style="margin-right: 10px;">üìã</span>
                                    <div>
                                        <div style="font-weight: 600;">Gestionar Usuarios</div>
                                        <div style="font-size: 12px; opacity: 0.8;">Ver y editar usuarios existentes</div>
                                    </div>
                                </button>
                                <button class="btn btn-secondary" onclick="exportUsers()" style="justify-content: flex-start; padding: 15px;">
                                    <span style="margin-right: 10px;">üì•</span>
                                    <div>
                                        <div style="font-weight: 600;">Exportar Datos</div>
                                        <div style="font-size: 12px; opacity: 0.8;">Descargar CSV de usuarios</div>
                                    </div>
                                </button>
                                <button class="btn btn-secondary" onclick="showSection('profile')" style="justify-content: flex-start; padding: 15px;">
                                    <span style="margin-right: 10px;">‚öôÔ∏è</span>
                                    <div>
                                        <div style="font-weight: 600;">Mi Perfil</div>
                                        <div style="font-size: 12px; opacity: 0.8;">Editar informaci√≥n personal</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actividad reciente -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üïê Actividad Reciente</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="activityFilter" style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px; font-size: 14px;">
                                <option value="all">Toda la actividad</option>
                                <option value="today">Hoy</option>
                                <option value="week">Esta semana</option>
                                <option value="month">Este mes</option>
                            </select>
                            <button class="btn btn-secondary" onclick="refreshActivity()" style="padding: 8px 16px; font-size: 14px;">
                                üîÑ Actualizar
                            </button>
                        </div>
                    </div>
                    <div style="padding: 0;">
                        <div id="recentActivityContainer">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">üñ•Ô∏è Estado del Sistema</h2>
                        </div>
                        <div style="padding: 25px;">
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface); border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                                        <span>API Gateway</span>
                                    </div>
                                    <span style="color: var(--success); font-weight: 600;">Online</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface); border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                                        <span>Auth Service</span>
                                    </div>
                                    <span style="color: var(--success); font-weight: 600;">Online</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface); border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                                        <span>Base de Datos</span>
                                    </div>
                                    <span style="color: var(--success); font-weight: 600;">Online</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">üìà M√©tricas R√°pidas</h2>
                        </div>
                        <div style="padding: 25px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div style="text-align: center; padding: 15px; background: var(--surface); border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--primary-medium);" id="avgDailyLogins">-</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Logins promedio/d√≠a</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: var(--surface); border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="uptime">99.9%</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Tiempo activo</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: var(--surface); border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="avgResponseTime">-</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Tiempo respuesta</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: var(--surface); border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--error);" id="errorRate">0.1%</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Tasa de error</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


                <!-- Users Section -->
                <div id="usersSection" class="content-section" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Gesti√≥n de Usuarios</h2>
                            <button class="btn" onclick="openCreateUserModal()">
                                ‚ûï Crear Usuario
                            </button>
                        </div>
                        
                        <!-- Filtros -->
                        <div style="padding: 20px 30px; border-bottom: 1px solid var(--border);">
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <input type="text" placeholder="Buscar usuarios..." class="form-input" style="max-width: 300px;" id="searchInput">
                                <select class="form-select" style="max-width: 150px;" id="roleFilter">
                                    <option value="">Todos los roles</option>
                                    <option value="admin">Admin</option>
                                    <option value="moderator">Moderador</option>
                                    <option value="user">Usuario</option>
                                </select>
                                <button class="btn btn-secondary" onclick="loadUsers()">üîç Filtrar</button>
                            </div>
                        </div>

                        <!-- Tabla de usuarios -->
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Email</th>
                                        <th>Rol</th>
                                        <th>Estado</th>
                                        <th>√öltimo acceso</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px;">
                                            <div class="loading"></div> Cargando usuarios...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="content-section" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Configuraci√≥n del Sistema</h2>
                        </div>
                        <div style="padding: 30px;">
                            <p>Configuraciones del sistema pr√≥ximamente...</p>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="content-section" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Mi Perfil</h2>
                        </div>
                        <div style="padding: 30px;">
                            <!-- Profile Grid -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                                <!-- Profile Info Card -->
                                <div style="background: var(--surface); border-radius: 12px; padding: 25px; border: 1px solid var(--border);">
                                    <div style="text-align: center; margin-bottom: 20px;">
                                        <div style="width: 80px; height: 80px; background: var(--primary-medium); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: 700; margin: 0 auto 15px;" id="profileAvatar">A</div>
                                        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 5px;" id="profileName">Cargando...</h3>
                                        <p style="color: var(--text-secondary); margin-bottom: 10px;" id="profileEmail">cargando@email.com</p>
                                        <span style="background: var(--primary-dark); color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; text-transform: uppercase;" id="profileRole">USER</span>
                                    </div>
                                    <button class="btn" onclick="toggleProfileEdit()" style="width: 100%;">
                                        <span id="editModeText">‚úèÔ∏è Editar Perfil</span>
                                    </button>
                                </div>

                                <!-- Profile Stats Card -->
                                <div style="background: var(--surface); border-radius: 12px; padding: 25px; border: 1px solid var(--border);">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 20px;">Estad√≠sticas de la Cuenta</h4>
                                    <div style="display: flex; flex-direction: column; gap: 15px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">Estado:</span>
                                            <span style="font-weight: 600;" id="accountStatus">Activa</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">Email verificado:</span>
                                            <span style="font-weight: 600;" id="emailVerified">‚úÖ S√≠</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">Miembro desde:</span>
                                            <span style="font-weight: 600;" id="memberSince">-</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">√öltimo acceso:</span>
                                            <span style="font-weight: 600;" id="lastLogin">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Edit Profile Form -->
                            <div id="profileEditForm" style="display: none; background: var(--white); border-radius: 12px; padding: 25px; border: 1px solid var(--border); margin-bottom: 30px;">
                                <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 20px;">Editar Informaci√≥n Personal</h4>
                                <div id="profileAlert" class="alert"></div>
                                <form id="updateProfileForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label class="form-label">Nombre</label>
                                        <input type="text" class="form-input" id="editFirstName" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Apellido</label>
                                        <input type="text" class="form-input" id="editLastName" required>
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-input" id="editEmail" required>
                                    </div>
                                    <div style="grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end;">
                                        <button type="button" class="btn btn-secondary" onclick="cancelProfileEdit()">Cancelar</button>
                                        <button type="submit" class="btn" id="saveProfileBtn">
                                            <span id="saveProfileText">üíæ Guardar</span>
                                            <div id="saveProfileLoading" class="loading" style="display: none;"></div>
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Change Password -->
                            <div style="background: var(--white); border-radius: 12px; padding: 25px; border: 1px solid var(--border);">
                                <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 20px;">Cambiar Contrase√±a</h4>
                                <div id="passwordAlert" class="alert"></div>
                                <form id="changePasswordForm" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label class="form-label">Contrase√±a Actual</label>
                                        <input type="password" class="form-input" id="currentPassword" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nueva Contrase√±a</label>
                                        <input type="password" class="form-input" id="newPassword" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Confirmar Nueva</label>
                                        <input type="password" class="form-input" id="confirmPassword" required>
                                    </div>
                                    <div style="grid-column: 1 / -1; display: flex; justify-content: flex-end;">
                                        <button type="submit" class="btn" id="changePasswordBtn">
                                            <span id="changePasswordText">üîë Cambiar Contrase√±a</span>
                                            <div id="changePasswordLoading" class="loading" style="display: none;"></div>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Crear/Editar Usuario -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Crear Usuario</h3>
                <button class="close-btn" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalAlert" class="alert"></div>
                
                <form id="userForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" class="form-input" id="userPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-input" id="userFirstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Apellido</label>
                        <input type="text" class="form-input" id="userLastName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rol</label>
                        <select class="form-select" id="userRole" required>
                            <option value="user">Usuario</option>
                            <option value="moderator">Moderador</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeUserModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn" id="submitBtn">
                            <span id="submitText">Crear Usuario</span>
                            <div id="submitLoading" class="loading" style="display: none;"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let currentUser = null;
        let authToken = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar si hay token guardado
            authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                window.location.href = 'index.html';
                return;
            }

            try {
                await verifyToken();
                await loadDashboard();
            } catch (error) {
                console.error('Error de inicializaci√≥n:', error);
                logout();
            }
        });

        // Verificar token
        async function verifyToken() {
            try {
                const response = await fetch(`${API_BASE}/auth/verify`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Token inv√°lido');

                const data = await response.json();
                currentUser = data.data.user;
                
                // Actualizar UI con info del usuario
                document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                document.getElementById('userAvatar').textContent = currentUser.firstName.charAt(0).toUpperCase();
                
            } catch (error) {
                throw new Error('Error verificando token');
            }
        }

        // Cargar dashboard
        async function loadDashboard() {
            try {
                await loadStats();
                await loadRoleStats();
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        // Cargar estad√≠sticas
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/users/stats/overview`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const data = await response.json();
                const stats = data.data;

                document.getElementById('totalUsers').textContent = stats.total;
                document.getElementById('activeUsers').textContent = stats.active;
                document.getElementById('recentUsers').textContent = stats.recent;
                document.getElementById('inactiveUsers').textContent = stats.inactive;

            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        // Cargar estad√≠sticas por rol
        async function loadRoleStats() {
            try {
                const response = await fetch(`${API_BASE}/users/stats/overview`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const data = await response.json();
                const roleStats = data.data.byRole;
                
                const container = document.getElementById('roleStats');
                container.innerHTML = '';

                roleStats.forEach(stat => {
                    const roleCard = document.createElement('div');
                    roleCard.className = 'stat-card';
                    roleCard.innerHTML = `
                        <div class="stat-value">${stat.count}</div>
                        <div class="stat-label">${stat.role.charAt(0).toUpperCase() + stat.role.slice(1)}</div>
                    `;
                    container.appendChild(roleCard);
                });

            } catch (error) {
                console.error('Error cargando estad√≠sticas por rol:', error);
            }
        }

        // Cargar usuarios
        async function loadUsers() {
            const search = document.getElementById('searchInput').value;
            const role = document.getElementById('roleFilter').value;
            
            try {
                let url = `${API_BASE}/users?`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (role) url += `role=${role}&`;

                const response = await fetch(url, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const data = await response.json();
                const users = data.data.users;

                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No se encontraron usuarios</td></tr>';
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 35px; height: 35px; background: var(--primary-medium); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                    ${user.first_name.charAt(0)}
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${user.first_name} ${user.last_name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${user.id.substring(0, 8)}...</div>
                                </div>
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td><span class="badge ${user.role}">${user.role}</span></td>
                        <td><span class="badge ${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'Activo' : 'Inactivo'}</span></td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Nunca'}</td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="editUser('${user.id}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                ${user.id !== currentUser.id ? `
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteUser('${user.id}', '${user.email}')">
                                    üóëÔ∏è Eliminar
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error cargando usuarios:', error);
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--error);">Error cargando usuarios</td></tr>';
            }
        }

        // Navegaci√≥n
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Actualizar navegaci√≥n activa
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                // Mostrar secci√≥n correspondiente
                const section = item.dataset.section;
                showSection(section);
            });
        });

        function showSection(section) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.style.display = 'none';
            });
            
            // Mostrar secci√≥n seleccionada
            const sectionElement = document.getElementById(section + 'Section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
            
            // Actualizar t√≠tulo
            const titles = {
                dashboard: 'Dashboard',
                users: 'Gesti√≥n de Usuarios',
                profile: 'Mi Perfil',
                settings: 'Configuraci√≥n'
            };
            document.getElementById('pageTitle').textContent = titles[section] || section;
            
            // Cargar datos seg√∫n la secci√≥n
            if (section === 'users') {
                loadUsers();
            } else if (section === 'dashboard') {
                loadDashboard();
            } else if (section === 'profile') {
                loadUserProfile();
            }
        }

        // Modal de usuario
        function openCreateUserModal() {
            document.getElementById('modalTitle').textContent = 'Crear Usuario';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').classList.add('show');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
            document.getElementById('modalAlert').classList.remove('show');
        }

        // Crear usuario
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            submitLoading.style.display = 'block';
            
            try {
                const userData = {
                    email: document.getElementById('userEmail').value,
                    password: document.getElementById('userPassword').value,
                    firstName: document.getElementById('userFirstName').value,
                    lastName: document.getElementById('userLastName').value,
                    role: document.getElementById('userRole').value
                };

                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (data.success) {
                    showModalAlert('Usuario creado exitosamente', 'success');
                    setTimeout(() => {
                        closeUserModal();
                        loadUsers();
                        loadDashboard(); // Actualizar estad√≠sticas
                    }, 1500);
                } else {
                    showModalAlert(data.message || 'Error creando usuario', 'error');
                }

            } catch (error) {
                console.error('Error creando usuario:', error);
                showModalAlert('Error de conexi√≥n', 'error');
            } finally {
                submitBtn.disabled = false;
                submitText.style.display = 'block';
                submitLoading.style.display = 'none';
            }
        });

        // Mostrar alerta en modal
        function showModalAlert(message, type) {
            const alert = document.getElementById('modalAlert');
            alert.textContent = message;
            alert.className = `alert ${type} show`;
        }

        // Editar usuario
        async function editUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const data = await response.json();
                const user = data.data.user;

                // Llenar formulario con datos del usuario
                document.getElementById('modalTitle').textContent = 'Editar Usuario';
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userEmail').disabled = true; // No permitir cambiar email
                document.getElementById('userPassword').required = false;
                document.getElementById('userPassword').placeholder = 'Dejar vac√≠o para mantener contrase√±a actual';
                document.getElementById('userFirstName').value = user.first_name;
                document.getElementById('userLastName').value = user.last_name;
                document.getElementById('userRole').value = user.role;
                
                document.getElementById('submitText').textContent = 'Actualizar Usuario';
                document.getElementById('userModal').classList.add('show');

            } catch (error) {
                console.error('Error cargando usuario:', error);
                alert('Error cargando datos del usuario');
            }
        }

        // Eliminar usuario
        async function deleteUser(userId, userEmail) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar al usuario ${userEmail}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Usuario eliminado exitosamente');
                    loadUsers();
                    loadDashboard(); // Actualizar estad√≠sticas
                } else {
                    alert(data.message || 'Error eliminando usuario');
                }

            } catch (error) {
                console.error('Error eliminando usuario:', error);
                alert('Error de conexi√≥n');
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        }

        // Filtros en tiempo real
        document.getElementById('searchInput').addEventListener('input', debounce(loadUsers, 500));
        document.getElementById('roleFilter').addEventListener('change', loadUsers);

        // Funci√≥n debounce para evitar demasiadas llamadas
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Actualizar estad√≠sticas cada 30 segundos
        setInterval(() => {
            if (document.getElementById('dashboardSection').style.display !== 'none') {
                loadDashboard();
            }
        }, 30000);

        // Manejar cierre de modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeUserModal();
            }
        });

        // Cerrar modal haciendo clic fuera
        document.getElementById('userModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('userModal')) {
                closeUserModal();
            }
        });

        // =================== FUNCIONES DE PERFIL ===================
        
        // Cargar perfil del usuario
        async function loadUserProfile() {
            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Error al cargar perfil');

                const data = await response.json();
                const user = data.data.user;
                const stats = data.data.stats;

                // Actualizar informaci√≥n del perfil
                document.getElementById('profileAvatar').textContent = user.first_name.charAt(0).toUpperCase();
                document.getElementById('profileName').textContent = `${user.first_name} ${user.last_name}`;
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profileRole').textContent = user.role.toUpperCase();

                // Actualizar estad√≠sticas
                document.getElementById('accountStatus').textContent = stats.accountStatus === 'active' ? 'Activa' : 'Inactiva';
                document.getElementById('emailVerified').textContent = stats.emailVerified ? '‚úÖ S√≠' : '‚ùå No';
                document.getElementById('memberSince').textContent = new Date(user.created_at).toLocaleDateString();
                document.getElementById('lastLogin').textContent = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Nunca';

                // Llenar formulario de edici√≥n
                document.getElementById('editFirstName').value = user.first_name;
                document.getElementById('editLastName').value = user.last_name;
                document.getElementById('editEmail').value = user.email;

            } catch (error) {
                console.error('Error cargando perfil:', error);
            }
        }

        // Toggle edici√≥n de perfil
        let isProfileEditMode = false;
        function toggleProfileEdit() {
            isProfileEditMode = !isProfileEditMode;
            const form = document.getElementById('profileEditForm');
            const button = document.getElementById('editModeText');
            
            if (isProfileEditMode) {
                form.style.display = 'block';
                button.textContent = '‚ùå Cancelar';
            } else {
                form.style.display = 'none';
                button.textContent = '‚úèÔ∏è Editar Perfil';
            }
        }

        // Cancelar edici√≥n de perfil
        function cancelProfileEdit() {
            toggleProfileEdit();
            document.getElementById('profileAlert').classList.remove('show');
        }

        // Actualizar perfil
        document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('saveProfileBtn');
            const text = document.getElementById('saveProfileText');
            const loading = document.getElementById('saveProfileLoading');
            
            btn.disabled = true;
            text.style.display = 'none';
            loading.style.display = 'block';
            
            try {
                const updateData = {
                    firstName: document.getElementById('editFirstName').value,
                    lastName: document.getElementById('editLastName').value,
                    email: document.getElementById('editEmail').value
                };

                const response = await fetch(`${API_BASE}/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();

                if (data.success) {
                    showProfileAlert('Perfil actualizado exitosamente', 'success');
                    setTimeout(() => {
                        toggleProfileEdit();
                        loadUserProfile();
                        hideProfileAlert();
                    }, 2000);
                } else {
                    showProfileAlert(data.message || 'Error actualizando perfil', 'error');
                }

            } catch (error) {
                console.error('Error actualizando perfil:', error);
                showProfileAlert('Error de conexi√≥n', 'error');
            } finally {
                btn.disabled = false;
                text.style.display = 'block';
                loading.style.display = 'none';
            }
        });

        // Cambiar contrase√±a
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('changePasswordBtn');
            const text = document.getElementById('changePasswordText');
            const loading = document.getElementById('changePasswordLoading');
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validaciones
            if (newPassword !== confirmPassword) {
                showPasswordAlert('Las contrase√±as nuevas no coinciden', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showPasswordAlert('La nueva contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            btn.disabled = true;
            text.style.display = 'none';
            loading.style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/auth/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword,
                        confirmPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPasswordAlert('Contrase√±a actualizada exitosamente', 'success');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    showPasswordAlert(data.message || 'Error cambiando contrase√±a', 'error');
                }

            } catch (error) {
                console.error('Error cambiando contrase√±a:', error);
                showPasswordAlert('Error de conexi√≥n', 'error');
            } finally {
                btn.disabled = false;
                text.style.display = 'block';
                loading.style.display = 'none';
            }
        });

        // Utilidades para alertas
        function showProfileAlert(message, type) {
            const alert = document.getElementById('profileAlert');
            alert.textContent = message;
            alert.className = `alert ${type} show`;
        }

        function hideProfileAlert() {
            document.getElementById('profileAlert').classList.remove('show');
        }

        function showPasswordAlert(message, type) {
            const alert = document.getElementById('passwordAlert');
            alert.textContent = message;
            alert.className = `alert ${type} show`;
        }
    </script>

    <script>
// Funciones mejoradas para el dashboard
function updateDateTime() {
    const now = new Date();
    const dateOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    };
    
    document.getElementById('currentDate').textContent = now.toLocaleDateString('es-ES', dateOptions);
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-ES', timeOptions);
}

// Actualizar cada segundo
setInterval(updateDateTime, 1000);
updateDateTime();

// Mejorar la funci√≥n loadRoleStats
async function loadRoleStats() {
    try {
        const response = await fetch(`${API_BASE}/users/stats/overview`, {
            headers: { Authorization: `Bearer ${authToken}` }
        });

        const data = await response.json();
        const roleStats = data.data.byRole;
        
        const container = document.getElementById('roleStatsContainer');
        container.innerHTML = '';

        const roleColors = {
            admin: 'linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-medium) 100%)',
            moderator: 'linear-gradient(135deg, var(--warning) 0%, #fd7e14 100%)',
            user: 'linear-gradient(135deg, var(--success) 0%, #20c997 100%)'
        };

        const roleIcons = {
            admin: 'üëë',
            moderator: 'üõ°Ô∏è',
            user: 'üë§'
        };

        roleStats.forEach(stat => {
            const roleCard = document.createElement('div');
            roleCard.style.cssText = `
                background: ${roleColors[stat.role] || 'var(--surface)'};
                color: white;
                padding: 20px;
                border-radius: 12px;
                text-align: center;
                box-shadow: var(--shadow);
            `;
            roleCard.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 10px;">${roleIcons[stat.role] || 'üìä'}</div>
                <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px;">${stat.count}</div>
                <div style="font-size: 14px; opacity: 0.9; text-transform: capitalize;">${stat.role}</div>
            `;
            container.appendChild(roleCard);
        });

    } catch (error) {
        console.error('Error cargando estad√≠sticas por rol:', error);
    }
}

// Funci√≥n para actividad reciente mejorada
async function loadRecentActivity() {
    try {
        const response = await fetch(`${API_BASE}/users/stats/overview`, {
            headers: { Authorization: `Bearer ${authToken}` }
        });

        const data = await response.json();
        const recentActivity = data.data.recentActivity;
        
        const container = document.getElementById('recentActivityContainer');
        container.innerHTML = '';

        if (recentActivity.length === 0) {
            container.innerHTML = `
                <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                    <div>No hay actividad reciente</div>
                </div>
            `;
            return;
        }

        recentActivity.forEach((activity, index) => {
            const activityItem = document.createElement('div');
            activityItem.style.cssText = `
                padding: 15px 25px;
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                gap: 15px;
                transition: background-color 0.2s ease;
            `;
            
            if (index === recentActivity.length - 1) {
                activityItem.style.borderBottom = 'none';
            }

            activityItem.innerHTML = `
                <div style="width: 40px; height: 40px; background: var(--primary-medium); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                    ${activity.first_name.charAt(0)}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">
                        ${activity.first_name} ${activity.last_name}
                    </div>
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        ${activity.email}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        ${new Date(activity.last_login).toLocaleDateString()}
                    </div>
                    <div style="font-size: 12px; color: var(--text-light);">
                        ${new Date(activity.last_login).toLocaleTimeString()}
                    </div>
                </div>
            `;

            activityItem.addEventListener('mouseenter', () => {
                activityItem.style.backgroundColor = 'var(--surface)';
            });
            
            activityItem.addEventListener('mouseleave', () => {
                activityItem.style.backgroundColor = 'transparent';
            });

            container.appendChild(activityItem);
        });

    } catch (error) {
        console.error('Error cargando actividad reciente:', error);
        document.getElementById('recentActivityContainer').innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--error);">
                <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <div>Error cargando actividad</div>
            </div>
        `;
    }
}

// Funci√≥n para exportar usuarios
async function exportUsers() {
    try {
        const response = await fetch(`${API_BASE}/users/export/csv`, {
            headers: { Authorization: `Bearer ${authToken}` }
        });

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `usuarios_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        // Mostrar notificaci√≥n de √©xito
        showNotification('Archivo CSV descargado exitosamente', 'success');
    } catch (error) {
        console.error('Error exportando usuarios:', error);
        showNotification('Error al exportar usuarios', 'error');
    }
}

// Funci√≥n para mostrar notificaciones
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success)' : 'var(--error)'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        box-shadow: var(--shadow-lg);
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    // Animar entrada
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);

    // Animar salida y remover
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Funciones de actualizaci√≥n
function refreshRoleStats() {
    loadRoleStats();
    showNotification('Estad√≠sticas actualizadas', 'success');
}

function refreshActivity() {
    loadRecentActivity();
    showNotification('Actividad actualizada', 'success');
}

// Actualizar mensaje de bienvenida
function updateWelcomeMessage() {
    if (currentUser) {
        const hour = new Date().getHours();
        let greeting = '';
        
        if (hour < 12) greeting = 'Buenos d√≠as';
        else if (hour < 18) greeting = 'Buenas tardes';
        else greeting = 'Buenas noches';
        
        document.getElementById('welcomeMessage').textContent = `${greeting}, ${currentUser.firstName}. Aqu√≠ tienes un resumen de tu sistema.`;
        document.getElementById('bannerAvatar').textContent = currentUser.firstName.charAt(0).toUpperCase();
        document.getElementById('bannerRole').textContent = currentUser.role.toUpperCase();
    }
}

// Mejorar la funci√≥n loadDashboard original
async function loadDashboardEnhanced() {
    try {
        await loadStats();
        await loadRoleStats();
        await loadRecentActivity();
        updateWelcomeMessage();
        
        // Calcular porcentajes y cambios
        const total = parseInt(document.getElementById('totalUsers').textContent) || 0;
        const active = parseInt(document.getElementById('activeUsers').textContent) || 0;
        
        if (total > 0) {
            const activePercentage = Math.round((active / total) * 100);
            document.getElementById('activeUsersPercentage').textContent = `${activePercentage}% del total`;
        }
        
        // Simular m√©tricas adicionales
        document.getElementById('avgDailyLogins').textContent = Math.round(total * 0.3);
        document.getElementById('avgResponseTime').textContent = '120ms';
        
    } catch (error) {
        console.error('Error cargando dashboard mejorado:', error);
    }
}

// Reemplazar la funci√≥n loadDashboard original con la mejorada
window.loadDashboard = loadDashboardEnhanced;
</script>
</body>
</html>